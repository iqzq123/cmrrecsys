<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="540" height="278"
	showCloseButton="true" close="closeHandle()" creationPolicy="all" title="图书漏斗分析">
	<mx:Metadata>
		[Event(name="mouseClick")]
	</mx:Metadata>
	<mx:Metadata>
		[Event(name="datasure",type="DataSureEvent")]
	</mx:Metadata>
	<mx:Script>
		<![CDATA[
			import mx.events.CloseEvent;
			import mx.messaging.messages.HTTPRequestMessage;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.http.mxml.HTTPService;
			import mx.rpc.events.ResultEvent;
			import mx.managers.PopUpManager;
			import mx.controls.Alert;
			import SNADisplay.org.utils.Events.DataSureEvent;
			
			private var fileWindow:FileWindow;
			private var selectedButton:String;
			private var tundishSuffix:String = "/图书漏斗.xml";
			private static const MINISECENDS:int=1000;
			private var taskID:String = "";
			
			private function openFileWindow(e:Event):void {
				selectedButton = ((e.target) as Button).id;
				fileWindow = new FileWindow;
				PopUpManager.addPopUp(fileWindow,this,true);
				PopUpManager.centerPopUp(fileWindow);
				fileWindow.addEventListener(Event.SELECT, getPath);
			}
			
			private function getPath(e:Event):void {
				if(selectedButton == "bt1" ) {
					textinput1.text = fileWindow.getFilePath();
				}
				else if(selectedButton == "bt2") {
					textinput2.text = fileWindow.getFilePath();
				}
			}
			
			private var intervalID:uint;
			private function confirm():void {
				taskID = getCurrentTime();
				var getBookTundish:HTTPService = new HTTPService();
				getBookTundish.resultFormat="e4x";
				getBookTundish.url="getBookTundish";
				var params:URLVariables = new URLVariables();
				params.bookString = encodeURIComponent(bookInput.text);
				params.readingInfoPath = encodeURIComponent(textinput1.text);
				params.tundishPath = encodeURIComponent(textinput2.text);
				params.action = "start";
				params.taskID = taskID;
								
				getBookTundish.addEventListener(FaultEvent.FAULT,faultHandler);

				getBookTundish.send(params);
				intervalID = setInterval(togetProgress,MINISECENDS);
				bt5.enabled = false;
			}
						
			private function faultHandler(e:FaultEvent):void {
				Alert.show(e.toString());
			}
			
			private function closeHandle():void {
	   			PopUpManager.removePopUp(this);
	   		}
	   		
	   		
	   		private var preNum:int = -2;
		    private var num:int;
		    private var i:int = 0;
		    private var count:int = 1;
	   		public function togetProgress():void {
		    	var getProgressService:HTTPService = new HTTPService();
		    	getProgressService.url = "getBookTundish";
		    	var params:URLVariables = new URLVariables();
		    	params.action = "progress";
		    	params.taskID = taskID;
		    	getProgressService.addEventListener(ResultEvent.RESULT,setProgressBar);
		    	getProgressService.send(params);
		    }
		    private function setProgressBar(e:ResultEvent):void {
		    	var line:String = String(e.result);
		    	var lines:Array = line.split(",");
		    	var chapterLine:int = new int(lines[0]);
		    	var readingInfoLine:int = new int(lines[1]);
		    	if(chapterLine>0&&readingInfoLine==0){
		    		progressBar.label = "读取章节信息...第"+chapterLine+"行";
		    		i+=5;
		    		if(i>100) i=0;
		    		progressBar.setProgress(i,100);
		    		preNum = chapterLine;
		    	}
		    	else if(chapterLine>0&&readingInfoLine>0) {
		    		if(preNum == readingInfoLine&&readingInfoLine>0){
		    			clearInterval(intervalID);
		    			progressBar.setProgress(100,100);
		    			progressBar.label = "执行完毕。";
		    			Alert.show("图书漏斗分析执行完毕！","",0,this,closeHandle2);
		    		}
		    		else{
		    			progressBar.label = "读取用户数据...第"+readingInfoLine+"行";
		    			i+=5;
		    			if(i>100) i=0;
		    			progressBar.setProgress(i,100);
		    			preNum = readingInfoLine;
		    		}		    		
		    	}
		    }
	   		
	   		private function closeHandle2(e:CloseEvent):void {
	   			PopUpManager.removePopUp(this);
	   		}
	   		
	   		private function checkBook():void {
	   			var bookString:String = encodeURIComponent(bookInput.text);
	   			if(bookString == "")Alert.show("请输入图书ID或者图书名");
	   			else {
	   				var checkBookService:HTTPService = new HTTPService();
	   				checkBookService.url = "checkBook";
	   				var params:URLVariables = new URLVariables();
	   				params.bookString = bookString;
	   				checkBookService.addEventListener(ResultEvent.RESULT,showFoundBook);
	   				checkBookService.send(params);
	   			}
	   		}
	   		
	   		private function showFoundBook(e:ResultEvent):void {
	   			var foundBookXML:XML = (XML) (e.message.body);
	   			var foundBookWindow:FoundBookWindow = new FoundBookWindow();
	   			foundBookWindow.addEventListener("datasure", function(e:DataSureEvent):void
					{
						bookInput.text = e.bookID;
					});
	   			PopUpManager.addPopUp(foundBookWindow,this,true);
   				PopUpManager.centerPopUp(foundBookWindow);
   				foundBookWindow.init(foundBookXML);
	   		}
	   		private function getCurrentTime():String {
	   			var date:Date = new Date;
	   			var month:String = correctTime("default",new String(date.getMonth()));
	   			var day:String = correctTime("default",new String(date.getDate()));
	   			var hour:String = correctTime("default",new String(date.getHours()));
	   			var minute:String = correctTime("default",new String(date.getMinutes()));
	   			var second:String = correctTime("default",new String(date.getSeconds()));
	   			var mmsecond:String = correctTime("mmsecond",new String(date.getMilliseconds()));
	   			var currentTime:String = month+day+hour+minute+second+mmsecond;
	   			return currentTime;
	   		}
	   		private function correctTime(type:String,str:String):String {
	   			var strNew:String = str;
	   			if(type == "default") {
	   				if(str.length == 1)strNew = "0"+str;
	   				else if(str.length == 0)strNew = "00";
	   			}
	   			else if(type == "mmsecond") {
	   				if(str.length == 1)strNew = "00"+str;
	   				else if(str.length == 2)strNew = "0"+str;
	   				else if(str.length == 0)strNew = "000";
	   			}
	   			return strNew;
	   		}
		]]>
	</mx:Script>
	
	<mx:Label x="36" y="40" text="图书ID或书名" fontSize="15" />
	<mx:Label id="label3" x="36" y="90" text="数据路径" width="104" height="27" fontSize="15" />
	<mx:Label id="label4" x="36" y="140" text="漏斗文件保存路径" width="135" height="27" fontSize="15" />
	
	<mx:TextInput id="bookInput" x="175" y="40" width="160" />
	<mx:TextInput id="textinput1" x="175" y="90" width="160"/>
	<mx:TextInput id="textinput2" x="175" y="140" width="160"/>
	
	<mx:Button id="checkBookBtn" x="345" y="40" label="检查书库中有无此书" fontSize="12" click="checkBook()" />
	<mx:Button id="bt1" x="345" y="90" label="浏览.." fontSize="12" click="openFileWindow(event)"/>
	<mx:Button id="bt2" x="345" y="140" label="浏览.." fontSize="12" click="openFileWindow(event)"/>
	<mx:ProgressBar id="progressBar" x="36" y="190" label="" visible="true" mode="manual"/>
	<mx:Button id="bt5" x="363" y="190" label="运行" fontSize="12" click="confirm()"/>
	<mx:Button id="bt6" x="436" y="190" label="取消" fontSize="12" click="closeHandle()"/>
	
</mx:TitleWindow>
